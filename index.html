<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Noto+Sans+JP:wght@100..900&family=WDXL+Lubrifont+JP+N&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material Symbols Outlined" rel="stylesheet">
<meta charset="UTF-8">
<title>色彩UM-異型と旅する放置ゲーム-</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

@media (min-width: 1024px) { #app { transform: scale(2); transform-origin: top center;}}

#app { width: 320px; margin: 0 auto;}
body { font-family: "M PLUS Rounded 1c", sans-serif;font-size: 12px; padding: 20px; background: #e0e6ef; min-height: 100vh;
  background: linear-gradient( 180deg, #aebdd4 0%, #e0e6ef 70%, #F3F5F9 100%
  );background-repeat: no-repeat;}
h2 { margin-top: 20px; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; background-color: #f9f9f9; opacity: 0.8;}
#partnerStatus, #colorStatus { margin-top: 10px; }
.colorDisplay { display: inline-block; width: 20px; height: 20px; border-radius: 50%; margin-left: 5px; vertical-align: middle; }
.m-plus-rounded-1c-bold {  font-family: "M PLUS Rounded 1c", sans-serif; font-weight: 500; font-style: normal;}
.status-header div {  white-space: pre-line;}

/* アイコン */
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.icon-image {
  width: 4em;
  height: 4em;
  border-radius: 10px;
  border: 2px solid #6E88A4;
  box-shadow: 3px 3px 0 #6E88A4;
  margin: 4px;
  padding: 2px;
  display: block;
}

.icon-image p {
  line-height: 1.5;
}

.icon-small {
  width: 3em;
  height: 3em;
  border-radius: 8px;
  border: 2px solid #6E88A4;
  box-shadow: 2px 2px 0 #6E88A4;
  margin: 2px;
  padding: 2px;
}

/* 共通オーバーレイ */
.icon-wrapper::after {
  content: "";
  position: absolute;
  inset: 0px;
  border-radius: 10px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}

/* 選択中 */
.icon-wrapper.selected::after {
  margin: 4px;
  background: rgba(110, 136, 164, 0.5);
  opacity: 1;
}

/* パートナー成立済み */
.icon-wrapper.used::after {
  margin: 4px;
  background: rgba(110, 136, 164, 0.5);
  opacity: 1;
}

/* 探索ゲージ */
.gauge {
  width: 200px;
  height: 14px;
  background: #dae1f0;
  border-radius: 10px;
  overflow: hidden;
  margin: 6px 6px;
}

.gauge-fill {
  height: 100%;
  background: linear-gradient(
    90deg,
    #7fa9ff,
    #9b7bff,
    #7fa9ff
  );
  background-size: 200% 100%;
  animation: gaugeMove 3s linear infinite;
  border-radius: 10px;
  transition: width 0.3s linear;
}

@keyframes gaugeMove {
  0%   { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

.partner-row {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 10px;
}

/* バッグ、色彩 */
#bag {
  padding: 16px;
  border: 4px solid #B69782;
  border-radius: 10px;
  background: #F3E9E3;
  box-shadow: 6px 6px 0 #B69782;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.color-orb {
  width: 1.5em;
  height: 1.5em;
  position: relative;
  border-radius: 63% 37% 35% 65% / 48% 58% 42% 52%;
  background-color: var(--orb-color);
  box-shadow:
    2px 2px 0 rgba(0,0,0,0.35),
    inset -2px -2px 0 rgba(0,0,0,0.15),
    inset 2px 2px 0 rgba(255,255,255,0.15);
  filter: none;
  display: inline-block;
  outline: 1px solid rgba(0,0,0,0.25);
  outline-offset: -1px;
}

.color-red    { --orb-color: #d92d2d; }
.color-blue   { --orb-color: #2f6ed9; }
.color-green  { --orb-color: #3ea35c; }
.color-orange { --orb-color: #e48a1f; }
.color-purple { --orb-color: #7a4bd9; }
.color-brown  { --orb-color: #8b4a2f; }
.color-black  { --orb-color: #2a2a2a; }

#warehouse {
  padding: 16px;
  border: 4px solid #B69782;
  border-radius: 10px;
  background: #F3E9E3;
  box-shadow: 6px 6px 0 #B69782;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px 12px;
}

.warehouse-slot {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  font-weight: bold;
}

.color-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.9);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.4);
}

#logo {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0.25;
  z-index: 0;
}

#logo img {
  max-width: 90%;
  width: 700px;
  height: auto;
}

#topButtons {
  margin-top: 40px; 
  margin-bottom: 10px;
}

#pageFooter {
  margin-top: 24px;
  padding: 12px 0;
  text-align: center;
  color: #666;
}

#pageFooter img {
  width: 90px;
  height: auto;
  opacity: 0.8;
}

/* ステータス要素 */
.status-card {
  padding: 15px;
  margin: 20px 0px;
  border: 4px solid #e0e6ef;
  border-radius: 10px;
  background: #8095AE;
  display: flex;
  flex-direction: column;
}

.status-image {
  width: 7em;
  height: 7em;
  border-radius: 10px;
  border: 3px solid #e0e6ef;
  padding: 4px;
  display: block;
}

.status-top {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 10px;
  min-height: 7em;
}

.status-header {
  width: 20em;
  margin: 5px 0px;
  min-height: 7em;
  border-radius: 10px;
  background: #e0e6ef;
  padding: 6px 15px 0px 15px;
  font-size: 1em;
  letter-spacing:0.5px;
}

.status-name {
  font-size: 1.3em;
  line-height: 200%;
  background: linear-gradient(transparent 60%, #aebdd4 60%);
}

.status-bottom {
  padding: 10px;
  border-radius: 10px;
  border: 4px solid #e0e6ef;
  background: #e0e6ef;
  display: flex;
  flex-direction: column;
}

/* ステータス、傾性部分 */
.keisei-row {
  display: flex;
  padding: 0px 0px 3px 0px;
  margin: 0px 0px 5px 0px;
  align-items: center;
  gap: 6px;
  background: linear-gradient(transparent 70%, #aebdd4 70%);
}

.keisei-label {
  font-size: 1.2rem;
  background-color: #8095AE;
  border: 4px solid #8095AE;
  border-radius: 4px;
  line-height: 1;
  color:#fff;
  margin: 4px;
}

.keisei-dot .color-orb {
  position:relative;
  transform: scale(1.2);
  top: 4px;
  margin: 2px;
}

.keisei-bar {
  width: 130px;
  height: 15px;
  margin: 3px;
  padding: 4px;
  border-radius: 3px;
  overflow: hidden;
  box-shadow:
  inset 1px 1px 2px rgba(0,0,0,0.1);
  margin-left: auto;
}

.keisei-fill {
  background: linear-gradient(
    90deg,
    #d4535d,
    #94323a,
  ); }

#statusTabs {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

#statusTabs .color-orb {
  transform: scale(1.5);
  margin: 10px;
  opacity: 0.5;
  cursor: pointer;
}

#statusTabs .color-orb.active {
  opacity: 1;
  transform: scale(2);
}

.tab {
  opacity: 0.5;
}

.tab.active {
  opacity: 1;
  outline: 2px solid #8095AE;
}

#stageDropdown {
  font-size: 1.1rem;
  margin: 0px 10px;
  padding: 6px 10px;
}

#kunnanButtons {
display: grid;
grid-template-columns: repeat(5, 1fr);
gap: 10px;
margin-top: 10px;
}

/* ドッスン風 苦難ボタン */
.kunnan-btn {
  height: 60px;
  background: #9a9a9a;
  border: 4px solid #6f6f6f;
  border-radius: 6px; /* 角が少し丸い */
  box-shadow:
    inset -3px -3px 0 rgba(0,0,0,0.2),
    inset 3px 3px 0 rgba(255,255,255,0.2);
  font-weight: bold;
  cursor: pointer;
}

.kunnan-btn.active {
  background: #d0d0d0;
  border: 4px solid #9a9a9a;
}

/* 苦難 */
#kunnan {
  width: 250px;
  height: 200px;
  margin: 40px auto;
}

.kunnan-body {
  position: relative;
  width: 250px;
  height: 200px;
  margin: 40px auto;
}

.kunnan-main,
.kunnan-sub {
  position: absolute;
  inset: 0;
}

.kunnan-main {
  z-index: 1;
  width: 250px;
  height: 200px;
  background-color: var(--main-color);
}

.kunnan-sub {
  z-index: 2;
  width: 250px;
  height: 200px;
  background-color: var(--sub-color);
}

/* 敵 */
#enemyStatus {
  margin: 16px auto;
  width: 220px;
  text-align: center;
}

.enemy-hp-label {
  font-size: 0.9em;
  margin-bottom: 4px;
  opacity: 0.7;
}

.enemy-hp-bar {
  height: 12px;
  background: #e0e0e0;     /* 背景は淡く */
  border-radius: 6px;
  overflow: hidden;
}

.enemy-hp-fill {
  height: 100%;
  width: 100%;
  background: #111;        /* 黒 */
  transition: width 0.3s linear;
}

.battle-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.battle-actions button {
  width: 45%;
}

.enemy-hp-text {
  margin-top: 4px;
  font-size: 0.85em;
  color: #111;
  opacity: 0.7;
}

#battleResult {
  margin-top: 20px;
  text-align: center;
}

.result-item {
  margin: 20px auto;
}

.result-label {
  font-size: 0.9em;
  opacity: 0.7;
  margin-bottom: 6px;
}

.result-box {
  width: 160px;
  height: 60px;
  margin: 0 auto;
  border: 2px solid #111;
  border-radius: 8px;
  background: #f5f5f5;
}

.result-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.result-actions button {
  width: 45%;
}

</style> </head> <body> <div id="app">

<div id="topButtons">
  <button onclick="showScreen('select')">パートナー</button>
  <button onclick="showScreen('search')">探索</button>
  <button onclick="showScreen('status')">能力</button>
  <button onclick="showScreen('battle')">戦闘</button></div>

<!-- 選択画面 -->
<div id="selectScreen">
<h2>少女を選択</h2>
 <div class="icon-wrapper" data-girl="淋漓"><img src="game_image/rinri.jpg" class="icon-image girl-icon" data-girl="淋漓"></div>
<div class="icon-wrapper" data-girl="唯奈">
 <img src="game_image/yuina.jpg" class="icon-image girl-icon" data-girl="唯奈"></div>
<div class="icon-wrapper" data-girl="スミレ"><img src="game_image/sumire.jpg" class="icon-image girl-icon" data-girl="スミレ"></div>

<h2>異型を選択</h2>
<div class="icon-wrapper" data-monster="安全 真"><img src="game_image/makoto.jpg" class="icon-image monster-icon" data-monster="安全 真"></div>
<div class="icon-wrapper" data-monster="幼 ユリ"><img src="game_image/yuri.jpg" class="icon-image monster-icon" data-monster="幼 ユリ"></div>
<div class="icon-wrapper" data-monster="目覚 崇"><img src="game_image/takashi.jpg" class="icon-image monster-icon" data-monster="目覚 崇"></div>
<div class="icon-wrapper" data-monster="風下 咲"><img src="game_image/saki.jpg" class="icon-image monster-icon" data-monster="風下 咲"></div>
<div class="icon-wrapper" data-monster="文豪 統"><img src="game_image/osamu.jpg" class="icon-image monster-icon" data-monster="文豪 統"></div>
<div class="icon-wrapper" data-monster="力業 透"><img src="game_image/tooru.jpg" class="icon-image monster-icon" data-monster="力業 透"></div>
<h2>3組選んだら...</h2>
<p><button id="mainButton" onclick="handleMainButton()">パートナー選択</button></p></div>

<div id="color-slot"></div>

<!-- 探索画面 -->
<div id="searchScreen" style="display:none;">
  <h2>パートナー</h2>
  <div id="partnerStatus"></div></div>
<div id="color-slot"></div>

<!-- ステータス画面 -->
<div id="statusScreen" style="display:none;">
  <h2>ステータス</h2>
<div id="statusTabs"></div>
<div id="statusList"></div></div>

<!-- 戦闘画面 -->
<div id="battleScreen" style="display:none;"><h2>戦闘画面</h2>

<!-- ステージ選択 -->
<div id="stageSelect">
  <label>
  <strong style="font-size: 1.5em;">ステージ選択</strong>
    <select id="stageDropdown">
      <option value="">- - - - -</option>
      <option value="1">ステージ 1</option>
      <option value="2">ステージ 2</option>
      <option value="2">ステージ 3</option>
    </select>
  </label>
</div>

<!-- 苦難選択 -->
<div id="kunnanSelect" style="display:none;">
  <h2>苦難を選択</h2>
  <div id="kunnanButtons"></div>
  </div>
  
<!-- バトルエリア -->
<div id="battleArea" style="display:none;">
  <h2>苦難を乗り越える</h2>

  <!-- 苦難表示 -->
  <div id="kunnan">
    <div class="kunnan-body">
      <div class="kunnan-main"></div>
      <div class="kunnan-sub"></div>
    </div>
  </div>

  <!-- 敵HP -->
  <div id="enemyStatus">
  <div class="enemy-hp-label">苦難</div>

  <div class="enemy-hp-bar">
    <div class="enemy-hp-fill"></div>
  </div>

  <!-- 追加 -->
  <div class="enemy-hp-text"></div>
</div>


  <!-- 行動ボタン -->
  <div class="battle-actions">
    <button class="fight-button">戦う</button>
    <button class="escape-button">逃げる</button>
  </div>
</div>

<!-- 勝利画面 -->
<div id="battleResult" style="display:none;">
  <h2>苦難を乗り越えた</h2>

  <div class="result-item">
    <div class="result-label">獲得したアイテム</div>
    <div class="result-box">
      <!-- 今は空欄 -->
    </div>
  </div>

  <div class="result-actions">
    <button class="fight-again-button">また戦う</button>
    <button class="escape-button">逃げる</button>
  </div>
</div>

</div>

<!-- 色彩（画面部品） -->
<div id="colorPanel">
  <h2>獲得色彩</h2>
  <div id="colorStatus"></div>

  <h2>色彩バッグ</h2>
  <div id="bag"></div>

  <h2>倉庫</h2>
  <div id="warehouse"></div></div>
  
  <script>

const colorMap = {
  "安全 真": "みどり",
  "幼 ユリ": "オレンジ",
  "目覚 崇": "あお",
  "風下 咲": "むらさき",
  "文豪 統": "ブラウン",
  "力業 透": "あか"
};
const colorCSS = {
  "みどり": "#2f9e44",
  "オレンジ": "#e67700",
  "あお": "#1c7ed6",
  "むらさき": "#7048e8",
  "ブラウン": "#8c4a1f",
  "あか": "#c92a2a",
  "くろ": "#1a1a1a"
};
const colorClassMap = {
  "みどり": "color-green",
  "オレンジ": "color-orange",
  "あお": "color-blue",
  "むらさき": "color-purple",
  "ブラウン": "color-brown",
  "あか": "color-red",
  "くろ": "color-black"
};
const girlImages = {
  "淋漓": "game_image/rinri.jpg",
  "唯奈": "game_image/yuina.jpg",
  "スミレ": "game_image/sumire.jpg"
};
const monsterImages = {
  "安全 真": "game_image/makoto.jpg",
  "幼 ユリ": "game_image/yuri.jpg",
  "目覚 崇": "game_image/takashi.jpg",
  "風下 咲": "game_image/saki.jpg",
  "文豪 統": "game_image/osamu.jpg",
  "力業 透": "game_image/tooru.jpg"
};
const colorBag = {
  "みどり": 0,
  "オレンジ": 0,
  "あお": 0,
  "むらさき": 0,
  "ブラウン": 0,
  "あか": 0,
  "くろ": 0
};
//ステータス設定資料
  const keisei_LABELS = {
  keisei_1: "凡",
  keisei_2: "恋",
  keisei_3: "異",
  keisei_4: "卑",
  keisei_5: "狂",
  keisei_6: "熱"
};

const IKEI_STATUS = {
  makoto: {
    name: "安全 真",
    description: "まじめで頑固\n例外や応用がわからない",
    image: "game_image/makoto_full.jpg",
    keisei: {
      keisei_1: 20,
      keisei_2: 4,
      keisei_3: 4,
      keisei_4: 12,
      keisei_5: 12,
      keisei_6: 12
    },
    color: "みどり"
  },
  yuri: {
    name: "幼 ユリ",
    description: "気分屋で惚れっぽい\nあなたがすべて",
    image: "game_image/yuri_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 20,
      keisei_3: 12,
      keisei_4: 4,
      keisei_5: 4,
      keisei_6: 12
    },
    color: "オレンジ"
  },
  takashi: {
    name: "目覚 崇",
    description: "陽気な道化\n異端こそ生き甲斐",
    image: "game_image/takashi_full.jpg",
    keisei: {
      keisei_1: 4,
      keisei_2: 12,
      keisei_3: 20,
      keisei_4: 4,
      keisei_5: 12,
      keisei_6: 12
    },
    color: "あお"
  },
  saki: {
    name: "風下 咲",
    description: "臆病で親切\n不安に苛まれている",
    image: "game_image/saki_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 12,
      keisei_3: 12,
      keisei_4: 20,
      keisei_5: 4,
      keisei_6: 4
    },
    color: "むらさき"
  },
  osamu: {
    name: "文豪 統",
    description: "思考と論理\n我在るのは思う為",
    image: "game_image/osamu_full.jpg",
    keisei: {
      keisei_1: 4,
      keisei_2: 12,
      keisei_3: 12,
      keisei_4: 12,
      keisei_5: 20,
      keisei_6: 4
    },
    color: "ブラウン"
  },
  tooru: {
    name: "力業 透",
    description: "剛腕と気合\n出来ないことなどない",
    image: "game_image/tooru_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 4,
      keisei_3: 4,
      keisei_4: 12,
      keisei_5: 12,
      keisei_6: 20
    },
    color: "あか"
  },
};

const COLOR_CLASSES = [
  "color-red",
  "color-blue",
  "color-green",
  "color-orange",
  "color-purple",
  "color-brown",
  "color-black"
];

const KUNNAN_HP = [30,40,50,60,70,80,90,100,120,150];

const PROGRESS_STEP = 25;
const TICK_INTERVAL = 500;
const COLOR_POOL = ["みどり","オレンジ","あお","むらさき","ブラウン","あか","くろ"];

let currentEnemy = {
  maxHp: 100,
  hp: 100
};

let lastBattle = {
  stage: null,
  hp: null
};

function selectMonster(monster) {
  if (!selectedGirl) {
    alert("先に少女を選んでね");
    return;
  }

  if (Object.values(selectedPairs).includes(monster)) {
    alert("その異型は他の少女とパートナーだよ");
    return;
  }

  selectedPairs[selectedGirl] = monster;
  selectedGirl = null;

  updateGirlStates();
  updateMonsterStates();
}

let partners = [];

function updatePartners() {
  partners = [];

  for (let girl in selectedPairs) {
    const monster = selectedPairs[girl];
    partners.push({
      girl,
      monster,
      progress: 0,
      speed: 1,
      isComplete: false,
      completeTimer: 0
    });
  }
  updateStatus();
}

function updateGirlStates() {
  document.querySelectorAll('.icon-wrapper[data-girl]').forEach(el => {
    const girl = el.dataset.girl;
    el.classList.remove("selected", "used");

    if (selectedPairs[girl]) {
      el.classList.add("used");
      
    } else if (girl === selectedGirl) {
      el.classList.add("selected");
    }
  });
}

function updateMonsterStates() {
  document.querySelectorAll('.icon-wrapper[data-monster]').forEach(el => {
    const monster = el.dataset.monster;
    el.classList.toggle(
      "used",
      Object.values(selectedPairs).includes(monster)
    );
  });
}

function updateStatus() {
  const area = document.getElementById("partnerStatus");
  area.innerHTML = "";

  partners.forEach(partner => {
    const ui = createPartnerFrame(partner);
    ui.fill.style.width = `${partner.progress}%`;
    area.appendChild(ui.row);
  });
}

function tick() {
  partners.forEach(partner => {

    if (partner.isComplete) {
      partner.completeTimer--;

      if (partner.completeTimer <= 0) {
        const colorsList = ["みどり","オレンジ","あお","むらさき","ブラウン","あか","くろ"];
        const color = colorsList[Math.floor(Math.random() * colorsList.length)];
        colorBag[color]++;
        renderColorBag();

        partner.progress = 0;
        partner.isComplete = false;
      }
      return;
    }

    partner.progress += PROGRESS_STEP * partner.speed;

    if (partner.progress >= 100) {
      partner.progress = 100;
      partner.isComplete = true;
      partner.completeTimer = 1; 
    }
  });
  updateStatus();
}

setInterval(tick, 500);

let selectedGirl = null;
let selectedPairs = {};

function selectGirl(girl) {
  selectedGirl = girl;
  updateGirlStates();
}
function confirmPartner() {
  updatePartners();
  showScreen("search");
}

let currentScreen = "select";

function showScreen(screenName) {
  const screens = ["select", "search", "status" ,"battle"];

  screens.forEach(name => {
    document.getElementById(name + "Screen").style.display =
      name === screenName ? "block" : "none";
  });
  const showColor =
    screenName === "search" || screenName === "status" || screenName === "select" || screenName === "battle";

  document.getElementById("colorPanel").style.display =
    showColor ? "block" : "none";
    
   if (screenName === "status") {
    renderStatusTabs();
    renderStatusScreen();
    attachColorPanel("statusScreen");
  }
   currentScreen = screenName;
}

function createPartnerFrame(partner) {
  const row = document.createElement("div");
  row.className = "partner-row";

  // 少女アイコン
  const girlImg = document.createElement("img");
  girlImg.src = girlImages[partner.girl];
  girlImg.className = "icon-small";

  // 異型アイコン
  const monsterImg = document.createElement("img");
  monsterImg.src = monsterImages[partner.monster];
  monsterImg.className = "icon-small";

  // ゲージ
  const gauge = document.createElement("div");
  gauge.className = "gauge";

  const fill = document.createElement("div");
  fill.className = "gauge-fill";
  fill.style.width = `${partner.progress}%`;

  gauge.appendChild(fill);

  row.appendChild(girlImg);
  row.appendChild(monsterImg);
  row.appendChild(gauge);

  const removeBtn = document.createElement("button");
   removeBtn.textContent = "×";
   removeBtn.onclick = () => removePartner(partner);

   row.appendChild(removeBtn);

  return { row, fill };
}

function renderColorBag() {
  const bag = document.getElementById("bag");
  const warehouse = document.getElementById("warehouse");

  bag.innerHTML = "";
  warehouse.innerHTML = "";

  for (let color in colorBag) {
    const count = colorBag[color];
    if (count === 0) continue;

    /* ===== バッグ（● 最大10） ===== */
    const bagFrame = document.createElement("div");
    bagFrame.className = "color-group";
    const bagCount = Math.min(count, 10);
   for (let i = 0; i < bagCount; i++) {
  const dot = document.createElement("span");

  dot.className = "color-orb";

  dot.classList.add(colorClassMap[color]);
  bagFrame.appendChild(dot);
}
bag.appendChild(bagFrame);

    /* ===== 倉庫（× 最大100） ===== */
    if (count > 10) {
      const group = document.createElement("div");
      group.className = "color-group";
      const orb = document.createElement("span");
      orb.className = "color-orb";
      orb.classList.add(colorClassMap[color]);
      const text = document.createElement("span");
      const warehouseCount = Math.min(count - 10, 100); 
      text.textContent = `× ${warehouseCount}`;

group.appendChild(orb);
group.appendChild(text);
warehouse.appendChild(group);
    }
  }
}

function removePartner(partner) {
  
  partners = partners.filter(t => t !== partner);
  delete selectedPairs[partner.girl];

  updateGirlStates();
  updateMonsterStates();
  updateStatus();
}

function handleMainButton() {
  if (currentScreen === "select") {
    confirmPartner();
  } else {
    showScreen("select");
  }
}

function attach(targetScreenId) {
  const slot = document
    .getElementById(targetScreenId)
    .querySelector(".color-slot");

  slot.appendChild(document.getElementById("colorPanel"));
}

// ステータス大枠
function renderStatusScreen() {
  const area = document.getElementById("statusList");
  area.innerHTML = "";
  
  Object.entries(IKEI_STATUS).forEach(([id, char]) => {
    const card = createStatusCard(char);
    card.dataset.charId = id;
    
    area.appendChild(card);
  });
}

function renderStatusTabs() {
  const tabs = document.getElementById("statusTabs");
  tabs.innerHTML = "";
  
  const allOrb = document.createElement("span");
  allOrb.className = "color-orb all";
  allOrb.dataset.charId = "all";
  allOrb.textContent = "ALL";

  allOrb.onclick = () => selectTab("all");
  tabs.appendChild(allOrb);
  
  Object.entries(IKEI_STATUS).forEach(([id, char]) => {
    const orb = document.createElement("span");
    orb.className = `color-orb ${colorClassMap[char.color]}`;
    orb.title = char.name;
    orb.dataset.charId = id;
    orb.onclick = () => {
  selectTab(id);
  showSingleStatus(id);
};
    tabs.appendChild(orb);
  });
}

function showSingleStatus(charId) {
  document.querySelectorAll(".status-card").forEach(card => {
    card.style.display =
      card.dataset.charId === charId ? "block" : "none";
  });
}

// ステータス詳細
function createStatusCard(char, charId) {
  const card = document.createElement("div");
  card.className = "status-card";
  card.dataset.charId = charId;

  const top = document.createElement("div");
  top.className = "status-top";

  const img = document.createElement("img");
  img.src = char.image;
  img.className = "status-image";

  const header = document.createElement("div");
  header.className = "status-header";

  const name = document.createElement("strong");
  name.className = "status-name";
  name.textContent = char.name;

  const desc = document.createElement("div");
  desc.textContent = char.description;

  header.appendChild(name);
  header.appendChild(desc);
  top.appendChild(img);
  top.appendChild(header);

  const bottom = document.createElement("div");
  bottom.className = "status-bottom";

  Object.entries(char.keisei).forEach(([key, value]) => {
    const row = document.createElement("div");
    row.className = "keisei-row";

    const label = document.createElement("span");
    label.className = "keisei-label";
    label.textContent = keisei_LABELS[key];

    const dotBox = document.createElement("div");
    dotBox.className = "keisei-dot";

    const colorClass = colorClassMap[char.color];
    const count = keiseiDot(value);

    for (let i = 0; i < count; i++) {
      const orb = document.createElement("span");
      orb.className = `color-orb ${colorClass}`;
      dotBox.appendChild(orb);
    }

    const bar = document.createElement("div");
    bar.className = "keisei-bar";

    row.appendChild(label);
    row.appendChild(dotBox);
    row.appendChild(bar);
    bottom.appendChild(row);
  });
  card.appendChild(top);
  card.appendChild(bottom);
  return card;
}

function selectTab(charId) {
  activeStatusId = charId;

  document.querySelectorAll(".status-card").forEach(card => {
  card.style.display =
  charId === "all" || card.dataset.charId === charId  ? "block"  : "none";
});
  document.querySelectorAll("#statusTabs .color-orb").forEach(orb => {
    orb.classList.toggle("active", orb.dataset.charId === charId);
  });
}

let activeStatusId = "all";

function keiseiDot(value) {
  if (value >= 16) return 3;
  if (value >= 8) return 2;
  return 1;
}

const stageDropdown = document.getElementById("stageDropdown");
const kunnans = document.getElementById("kunnanSelect");
const buttonsArea = document.getElementById("kunnanButtons");

stageDropdown.addEventListener("change", () => {
  const stage = stageDropdown.value;

  if (!stage) {
    kunnans.style.display = "none";
    return;
  }
  renderKunnans(stage);
  kunnans.style.display = "block";
  buttonsArea.style.display = "grid";
});

function renderKunnans(stage) {
  buttonsArea.innerHTML = "";

  const { mainColor, subColor } = pickMainAndSubColors();
  console.log("picked colors:", mainColor, subColor);

  KUNNAN_HP.forEach((hp, index) => {
    const btn = document.createElement("button");
    btn.className = "kunnan-btn";
    btn.textContent = `${index + 1}`;

    btn.onclick = () => {
  setActiveButton(btn);
  startBattle(stage, hp);
};
    buttonsArea.appendChild(btn);
  });
}

function setActiveButton(activeBtn) {
  document.querySelectorAll(".kunnan-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  activeBtn.classList.add("active");
}

function startBattle(stage, hp) {
  document.getElementById("stageSelect").style.display = "none";
  document.getElementById("kunnanSelect").style.display = "none";
  document.getElementById("battleArea").style.display = "block";
  
  lastBattle.stage = stage;
  lastBattle.hp = hp;

  currentEnemy.maxHp = hp;
  currentEnemy.hp = hp;
  renderEnemyHp();

  const { mainColor, subColor } = pickMainAndSubColors();

  const main = document.querySelector(".kunnan-main");
  const sub  = document.querySelector(".kunnan-sub");

  main.style.setProperty("--main-color", mainColor);
  sub.style.setProperty("--sub-color", subColor);
  
  const mainMask = createMainMask();
  const subMask  = createSubMask();

  main.style.maskImage = `url(${mainMask.toDataURL()})`;
  main.style.webkitMaskImage = `url(${mainMask.toDataURL()})`;

  sub.style.maskImage = `url(${subMask.toDataURL()})`;
  sub.style.webkitMaskImage = `url(${subMask.toDataURL()})`;

  main.style.maskSize = sub.style.maskSize = "cover";
  main.style.maskRepeat = sub.style.maskRepeat = "no-repeat";
}
  
function showBattleResult() {
  document.getElementById("battleArea").style.display = "none";
  document.getElementById("battleResult").style.display = "block";
}
  
  
// 逃げる
function escapeBattle() {
  closeBattleResult();
  document.getElementById("battleArea").style.display = "none";
  document.getElementById("kunnanSelect").style.display = "block";
  
  const battleArea = document.getElementById("battleArea");
  const kunnans    = document.getElementById("kunnanSelect");
  
  battleArea.style.display = "none";
  kunnans.style.display = "block";
}

document.querySelectorAll(".escape-button").forEach(btn => {
  btn.addEventListener("click", escapeBattle);
});

// 苦難 侵食 メイン（歪んだ核）
function createMainMask(size = 200) {
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size / 2;
  const cy = size / 2;

  ctx.fillStyle = "black";

  // メイン塊の数（2〜4）
  const coreCount = 2 + Math.floor(Math.random() * 3);

  for (let i = 0; i < coreCount; i++) {
    const angle = Math.random() * Math.PI * 2;
    const offset = size * (0.05 + Math.random() * 0.40);
    const r = size * (0.22 + Math.random() * 0.12);

    const x = cx + Math.cos(angle) * offset;
    const y = cy + Math.sin(angle) * offset;

    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }

  return canvas;
}

// 苦難 侵食 サブ
function createSubMask(size = 200) {
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size / 2;
  const cy = size / 2;
  ctx.fillStyle = "black";
  const count = 8 + Math.floor(Math.random() * 15);
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const dist = size * (0.25 + Math.random() * 0.2);
    const r = size * (0.03 + Math.random() * 0.05);
    const x = cx + Math.cos(angle) * dist;
    const y = cy + Math.sin(angle) * dist;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }  return canvas;
}

function pickMainAndSubColors() {
  const colors = [
    "#d92d2d", "#2f6ed9", "#3ea35c",
    "#e48a1f", "#7a4bd9", "#8b4a2f"
  ];
  const mainColor = colors[Math.floor(Math.random() * colors.length)];
  let subColor;
  do { subColor = colors[Math.floor(Math.random() * colors.length)];
  } while (subColor === mainColor);
  return { mainColor, subColor };
}

document.querySelectorAll(".girl-icon").forEach(img => {
  img.addEventListener("click", () => {
    const girl = img.dataset.girl;
    selectGirl(girl);
  });
});

document.querySelectorAll(".monster-icon").forEach(img => {
  img.addEventListener("click", () => {
    const monster = img.dataset.monster;
    selectMonster(monster);
  });
});

function renderEnemyHp() {
  const fill = document.querySelector(".enemy-hp-fill");
  const text = document.querySelector(".enemy-hp-text");
  if (!fill || !text) return;

  const ratio = currentEnemy.hp / currentEnemy.maxHp;
  fill.style.width = `${Math.max(0, ratio * 100)}%`;

  // 追加
  text.textContent = `${currentEnemy.hp} / ${currentEnemy.maxHp}`;
}

function fightOnce() {
  // 仮ダメージ：あとで傾性に置き換える
  const damage = 10;

  currentEnemy.hp -= damage;
  if (currentEnemy.hp <= 0) {
    currentEnemy.hp = 0;
    renderEnemyHp();
  showBattleResult();
    return;
  }
  renderEnemyHp();
}

function fightAgain() {
  closeBattleResult();

  if (!lastBattle.hp) {
    // 保険：何も記録がなければ苦難選択へ
    document.getElementById("kunnanSelect").style.display = "block";
    return;
  }

  // 同じ強さで再戦（＝苦難を再抽選）
  startBattle(lastBattle.stage, lastBattle.hp);
}

document.querySelectorAll(".fight-button").forEach(btn => {
  btn.addEventListener("click", fightOnce);
});

document.querySelectorAll(".fight-again-button").forEach(btn => {
  btn.addEventListener("click", fightAgain);
});

function closeBattleResult() {
  document.getElementById("battleResult").style.display = "none";
}

</script>

<footer id="pageFooter"><img src="game_image/logo.png" alt="色彩UM ロゴ"></footer>

</div> </body> </html>