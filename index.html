<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Noto+Sans+JP:wght@100..900&family=WDXL+Lubrifont+JP+N&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material Symbols Outlined" rel="stylesheet">
<meta charset="UTF-8">
<title>色彩UM-異型と旅する放置ゲーム-</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

@media (min-width: 1024px) { #app { transform: scale(2); transform-origin: top center;}}
#app { width: 320px; margin: 0 auto;}
body { font-family: "M PLUS Rounded 1c", sans-serif;font-size: 12px; padding: 10px; background: #e0e6ef; min-height: 100vh;
  background: linear-gradient( 180deg, #aebdd4 0%, #e0e6ef 70%, #F3F5F9 100%
  );background-repeat: no-repeat;}
h2 { margin-top: 20px; }
button { padding: 5px 10px; margin: 2px; cursor: pointer; background-color: #f9f9f9; opacity: 0.8;}
#partnerStatus, #colorStatus { margin-top: 10px; }
.colorDisplay { display: inline-block; width: 20px; height: 20px; border-radius: 50%; margin-left: 5px; vertical-align: middle; }
.m-plus-rounded-1c-bold {  font-family: "M PLUS Rounded 1c", sans-serif; font-weight: 500; font-style: normal;}
.status-header div {  white-space: pre-line;}

/* アイコン */
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.icon-image {
  width: 4em;
  height: 4em;
  border-radius: 10px;
  border: 2px solid #6E88A4;
  box-shadow: 3px 3px 0 #6E88A4;
  margin: 4px;
  padding: 2px;
  display: block;
}

.icon-image p {
  line-height: 1.5;
}

.icon-small {
  width: 3em;
  height: 3em;
  border-radius: 8px;
  border: 2px solid #6E88A4;
  box-shadow: 2px 2px 0 #6E88A4;
  margin: 2px;
  padding: 2px;
}

/* 共通オーバーレイ */
.icon-wrapper::after {
  content: "";
  position: absolute;
  inset: 0px;
  border-radius: 10px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}

/* 選択中 */
.icon-wrapper.selected::after {
  margin: 4px;
  background: rgba(110, 136, 164, 0.5);
  opacity: 1;
}

/* パートナー成立済み */
.icon-wrapper.used::after {
  margin: 4px;
  background: rgba(110, 136, 164, 0.5);
  opacity: 1;
}

/* 探索ゲージ */
.gauge {
  width: 200px;
  height: 14px;
  background: #dae1f0;
  border-radius: 10px;
  overflow: hidden;
  margin: 6px 6px;
}

.gauge-fill {
  height: 100%;
  background: linear-gradient(
    90deg,
    #7fa9ff,
    #9b7bff,
    #7fa9ff
  );
  background-size: 200% 100%;
  animation: gaugeMove 3s linear infinite;
  border-radius: 10px;
  transition: width 0.3s linear;
}

@keyframes gaugeMove {
  0%   { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

.partner-row {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-bottom: 10px;
}

/* バッグ、色彩 */
#bag {
  padding: 16px;
  border: 4px solid #B69782;
  border-radius: 10px;
  background: #F3E9E3;
  box-shadow: 6px 6px 0 #B69782;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.color-orb {
  width: 1.5em;
  height: 1.5em;
  position: relative;
  border-radius: 63% 37% 35% 65% / 48% 58% 42% 52%;
  background-color: var(--orb-color);
  box-shadow:
    2px 2px 0 rgba(0,0,0,0.35),
    inset -2px -2px 0 rgba(0,0,0,0.15),
    inset 2px 2px 0 rgba(255,255,255,0.15);
  filter: none;
  display: inline-block;
  outline: 1px solid rgba(0,0,0,0.25);
  outline-offset: -1px;
}

.color-red    { --orb-color: #d92d2d; }
.color-blue   { --orb-color: #2f6ed9; }
.color-green  { --orb-color: #3ea35c; }
.color-orange { --orb-color: #e48a1f; }
.color-purple { --orb-color: #7a4bd9; }
.color-brown  { --orb-color: #8b4a2f; }

#warehouse {
  padding: 16px;
  border: 4px solid #B69782;
  border-radius: 10px;
  background: #F3E9E3;
  box-shadow: 6px 6px 0 #B69782;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px 12px;
}

.warehouse-slot {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  font-weight: bold;
}

.color-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.9);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.4);
}

#logo {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0.25;
  z-index: 0;
}

#logo img {
  max-width: 90%;
  width: 700px;
  height: auto;
}

#topButtons {
  margin-top: 40px; 
  margin-bottom: 10px;
}

#pageFooter {
  margin-top: 24px;
  padding: 12px 0;
  text-align: center;
  color: #666;
}

#pageFooter img {
  width: 90px;
  height: auto;
  opacity: 0.8;
}

/* ステータス要素 */
.status-card {
  padding: 15px;
  margin: 20px 0px;
  border: 4px solid #e0e6ef;
  border-radius: 10px;
  background: #8095AE;
  display: flex;
  flex-direction: column;
}

.status-top {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 10px;
  min-height: 7em;
}

.status-image {
  width: 7em;
  height: 7em;
  border-radius: 10px;
  border: 3px solid #e0e6ef;
  padding: 4px;
  display: block;
}

.status-header {
  width: 20em;
  margin: 5px 0px;
  min-height: 7em;
  border-radius: 10px;
  background: #e0e6ef;
  padding: 6px 15px 0px 15px;
  font-size: 1em;
  letter-spacing:0.5px;
}

.status-name {
  font-size: 1.3em;
  line-height: 200%;
  background: linear-gradient(transparent 60%, #aebdd4 60%);
}

.status-center {
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: 4px solid #e0e6ef;
  background: #e0e6ef;
  display: flex;
  flex-direction: column;
}

/* ステータス、傾性部分 */
.keisei-row {
  display: flex;
  padding: 0px 0px 3px 0px;
  margin: 0px 0px 5px 0px;
  align-items: center;
  gap: 6px;
  background: linear-gradient(transparent 70%, #aebdd4 70%);
}

.keisei-label {
  font-size: 1.2rem;
  background-color: #8095AE;
  border: 4px solid #8095AE;
  border-radius: 4px;
  line-height: 1;
  color:#fff;
  margin: 4px;
}

.keisei-dot .color-orb {
  position:relative;
  transform: scale(1.2);
  top: 4px;
  margin: 2px;
}

.keisei-bar {
  width: 130px;
  height: 15px;
  margin: 3px;
  padding: 4px;
  border-radius: 3px;
  overflow: hidden;
  box-shadow:
  inset 1px 1px 2px rgba(0,0,0,0.1);
  margin-left: auto;
}

.keisei-fill {
  background: linear-gradient(
    90deg,
    #d4535d,
    #94323a,
  ); }

.status-bottom {
  padding: 10px;
  border-radius: 10px;
  border: 4px solid #e0e6ef;
  background: #e0e6ef;
  display: flex;
}

.status-CheckArea {
  width: 3em;
  height: 3em;
}

.status-kikkake-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

#statusTabs {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

#statusTabs .color-orb {
  transform: scale(1.5);
  margin: 5px 10px;
  opacity: 0.5;
  cursor: pointer;
}

#statusTabs .color-orb.active {
  opacity: 1;
  transform: scale(2);
}

.tab {
  opacity: 0.5;
}

.tab.active {
  opacity: 1;
  outline: 2px solid #8095AE;
}

#kunnanButtons {
display: grid;
grid-template-columns: repeat(5, 1fr);
gap: 10px;
margin-top: 10px;
}

/* ドッスン風 苦難ボタン */
.kunnan-btn {
  height: 60px;
  background: #9a9a9a;
  border: 4px solid #6f6f6f;
  border-radius: 6px; /* 角が少し丸い */
  box-shadow:
    inset -3px -3px 0 rgba(0,0,0,0.2),
    inset 3px 3px 0 rgba(255,255,255,0.2);
  font-weight: bold;
  cursor: pointer;
}

.kunnan-btn.active {
  background: #d0d0d0;
  border: 4px solid #9a9a9a;
}

/* 苦難 */
#kunnan {
  width: 250px;
  height: 180px;
  margin: 10px auto;
}

.kunnan-body {
  position: relative;
  width: 250px;
  height: 180px;
  margin: 10px auto;
}

.kunnan-main,
.kunnan-sub {
  position: absolute;
  inset: 0;
}

.kunnan-main {
  z-index: 1;
  width: 250px;
  height: 180px;
  background-color: var(--main-color);
}

.kunnan-sub {
  z-index: 2;
  width: 250px;
  height: 180px;
  background-color: var(--sub-color);
}

/* 敵 */
#enemyStatus {
  margin: 16px auto;
  width: 220px;
  text-align: center;
}

.enemy-hp-label {
  font-size: 0.9em;
  margin-bottom: 4px;
  opacity: 0.7;
}

.enemy-hp-bar {
  height: 12px;
  background: #e0e0e0;     /* 背景は淡く */
  border-radius: 6px;
  overflow: hidden;
}

.enemy-hp-fill {
  height: 100%;
  width: 100%;
  background: #111;        /* 黒 */
  transition: width 0.3s linear;
}

.battle-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}

.battle-actions button {
  width: 45%;
}

.enemy-hp-text {
  margin-top: 4px;
  font-size: 0.85em;
  color: #111;
  opacity: 0.7;
}

#battleResult {
  margin-top: 20px;
  text-align: center;
}

.result-item {
  margin: 20px auto;
}

.result-label {
  font-size: 0.9em;
  opacity: 0.7;
  margin-bottom: 6px;
}

.result-box {
  width: 250px;
  height: 60px;
  margin: 5px auto;
  padding: 10px;
  border: 2px solid #111;
  border-radius: 8px;
  background: #f5f5f5;
}

.result-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.result-actions button {
  width: 45%;
}

.battle-actions {
  margin-top: 5px;
  display: flex;
  flex-direction: column; 
  align-items: center;
}

.battle-partners {
  display: flex;
  justify-content: center;
  gap: 16px;
  margin: 5px auto 20px auto;
}

/* 戦闘中の異型アイコン */
.battle-partner-icon {
  transition: transform 0.12s ease-out;
  cursor: pointer;
}

/* 押されたとき */
.battle-partner-icon.attack {
  transform: translateY(-6px);
}

.battle-partner {
  display: flex;
  flex-direction: column;
  align-items: center; /* アイコン基準で中央 */
}

.battle-partner-stats {
  margin-top: 4px;
  font-size: 1em;
  line-height: 1.4;
  opacity: 0.85;
}

.check-svg path {
  stroke-dasharray: 40;
  stroke-dashoffset: 0;
}

.check-svg.redraw path {
  stroke-dashoffset: 40;
  animation: redraw-check 0.4s ease-out forwards;
}

@keyframes redraw-check {
  to {
    stroke-dashoffset: 0;
  }
}

.status-CheckArea {
  width: 3em;
  height: 3em;
  border-radius: 6px;

  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.kikkake-popup {
  position: absolute;
  top: 110%;
  left: 0;
  width: 15rem;

  background: #f5f5f5;
  border: 2px solid #8095AE;
  border-radius: 6px;
  padding: 6px 8px;

  font-size: 0.7rem;
  display: none;
  z-index: 10;
}

.status-CheckArea.show-popup .kikkake-popup {
  display: block;
}

.kikkake-item {
  margin: 2px 0;
}
#kunnanGate {
  --gate-bg: #fff;
  position: relative;
}

#kunnanGate::before {
  content: "";
  position: absolute;
  inset: 0;
  background: var(--gate-bg);
  z-index: 0;
  transition: background 0.5s;
  border-radius: 50px;
}

.kunnan-gate-ui {
  position: relative;
  z-index: 1;
}

.kunnan-gate-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.kunnan-gate-bg {
  width: 100%;
  padding: 2.5rem 0;
  margin: 5rem 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.5s linear;
}

.kunnan-gate-ui {
  display: flex;
  justify-content: center;
  gap: 0.8rem;
}

.gate-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;

  width: 5rem;
  background: none;
  border: none;
  cursor: pointer;
  font-family: inherit;
}

.gate-card img {
  width: 5rem;
  height: 5rem;
}

.gate-card span {
  font-size: 0.85rem;
  color: #000;
  white-space: nowrap;
}

</style> </head>
<body> <div id="app">

<div id="topButtons">
  <button onclick="showScreen('select')">パートナー</button>
  <button onclick="showScreen('search')">探索</button>
  <button onclick="showScreen('status')">能力</button>
  <button onclick="showScreen('battle')">戦闘</button></div>

<!-- 選択画面 -->
<div id="selectScreen">
<h2>少女を選択</h2>
 <div class="icon-wrapper" data-girl="淋漓"><img src="image/rinri.jpg" class="icon-image girl-icon" data-girl="淋漓"></div>
<div class="icon-wrapper" data-girl="唯奈">
 <img src="image/yuina.jpg" class="icon-image girl-icon" data-girl="唯奈"></div>
<div class="icon-wrapper" data-girl="スミレ"><img src="image/sumire.jpg" class="icon-image girl-icon" data-girl="スミレ"></div>

<h2>パートナーの異形を選んでね</h2>
<div class="icon-wrapper" data-monster-id="makoto"><img src="image/makoto.jpg" class="icon-image monster-icon"></div>
<div class="icon-wrapper" data-monster-id="yuri"><img src="image/yuri.jpg" class="icon-image monster-icon"></div>
<div class="icon-wrapper" data-monster-id="takashi"><img src="image/takashi.jpg" class="icon-image monster-icon"></div>
<div class="icon-wrapper" data-monster-id="saki"><img src="image/saki.jpg" class="icon-image monster-icon"></div>
<div class="icon-wrapper" data-monster-id="osamu"><img src="image/osamu.jpg" class="icon-image monster-icon"></div>
<div class="icon-wrapper" data-monster-id="tooru"><img src="image/tooru.jpg" class="icon-image monster-icon"></div>
<h2>3組選んだら...</h2>
<p><button id="mainButton" onclick="handleMainButton()">パートナー選択</button></p></div>

<div id="color-slot"></div>

<!-- 探索画面 -->
<div id="searchScreen" style="display:none;">
  <h2>パートナー</h2>
  <div id="partnerStatus"></div></div>
<div id="color-slot"></div>

<!-- ステータス画面 -->
<div id="statusScreen" style="display:none;">
  <h2>ステータス</h2>
<div id="statusTabs"></div>
<div id="statusList"></div></div>

<!-- 戦闘画面 -->
<div id="battleScreen" style="display:none;">

<!-- 苦難ゲート -->
<div id="kunnanGate" style="display:none;">
  <div id="kunnanGateBg" class="kunnan-gate-bg">
<div class="kunnan-gate-ui">
  <button id="goShallow" class="gate-card">
    <img src="image/stepdown.gif" alt="浅くへ">
    <span>より浅く</span>
  </button>

  <button id="enterKunnan" class="gate-card">
    <img src="image/stepin.gif" alt="苦難に挑む">
    <span>苦難に挑む</span>
  </button>

  <button id="goDeep" class="gate-card">
    <img src="image/stepup.gif" alt="深くへ">
    <span>より深く</span>
  </button>
    </div>
  </div>
</div>
  
<!-- バトルエリア -->
<div id="battleArea" style="display:none;">
  <h2>苦難を乗り越える</h2>

  <!-- 苦難表示 -->
  <div id="kunnan">
    <div class="kunnan-body">
      <div class="kunnan-main"></div>
      <div class="kunnan-sub"></div>
    </div>
  </div>

  <!-- 敵HP -->
  <div id="enemyStatus">
  <div class="enemy-hp-label">苦難</div>
  <div class="enemy-hp-bar">
    <div class="enemy-hp-fill"></div>
  </div>
  <div class="enemy-hp-text"></div>
</div>

  <!-- 行動エリア -->
<div class="battle-actions">
  <div class="battle-partners">
    </div>
  <button class="escape-button">逃げる</button>
</div>

</div>

<!-- 勝利画面 -->
<div id="battleResult" style="display:none;">
  <h2>苦難を乗り越えた</h2>

  <div class="result-item">
    <div class="result-label">獲得したきっかけ</div>
    <div class="result-box">
      <div id="kikkakeResult"></div>
    </div>
  </div>

  <div class="result-actions">
    <button class="fight-again-button">また戦う</button>
    <button class="escape-button">逃げる</button>
  </div>
</div>

</div>

<!-- 色彩（画面部品） -->
<div id="colorPanel">
  <div id="colorStatus"></div>
  <h2>色彩バッグ</h2>
  <div id="bag"></div>

  <h2>倉庫</h2>
  <div id="warehouse"></div></div>
  
<script>

const colorMap = {
  "安全 真": "みどり",
  "幼 ユリ": "オレンジ",
  "目覚 崇": "あお",
  "風下 咲": "むらさき",
  "文豪 統": "ブラウン",
  "力業 透": "あか"
};//色整理-NAME

const colorCSS = {
  "みどり": "#2f9e44",
  "オレンジ": "#e67700",
  "あお": "#1c7ed6",
  "むらさき": "#7048e8",
  "ブラウン": "#8c4a1f",
  "あか": "#c92a2a",
  "くろ": "#1a1a1a"
};//色整理-NAME→HEX

const colorClassMap = {
  "みどり": "color-green",
  "オレンジ": "color-orange",
  "あお": "color-blue",
  "むらさき": "color-purple",
  "ブラウン": "color-brown",
  "あか": "color-red",
  
  "green": "color-green",
  "orange": "color-orange",
  "blue": "color-blue",
  "purple": "color-purple",
  "brown": "color-brown",
  "red": "color-red",
};//色整理-NAME→CLASS
// 色整理-orb：獲得orbとステータス画面orbが混在（orb整理時に着手予定）

const girlImages = {
  "淋漓": "image/rinri.jpg",
  "唯奈": "image/yuina.jpg",
  "スミレ": "image/sumire.jpg"
};

const monsterImages = {
  makoto: "image/makoto.jpg",
  yuri: "image/yuri.jpg",
  takashi: "image/takashi.jpg",
  saki: "image/saki.jpg",
  osamu: "image/osamu.jpg",
  tooru: "image/tooru.jpg"
};

const colorBag = {
  "green": 0,
  "orange": 0,
  "blue": 0,
  "purple": 0,
  "brown": 0,
  "red": 0,
};

const keisei_LABELS = {
  keisei_1: "凡",
  keisei_2: "恋",
  keisei_3: "異",
  keisei_4: "卑",
  keisei_5: "狂",
  keisei_6: "熱"
};

const IKEI_STATUS = {
  makoto: {
    name: "安全 真",
    description: "まじめで頑固\n例外や応用を知らない",
    image: "image/makoto_full.jpg",
    keisei: {
      keisei_1: 20,
      keisei_2: 4,
      keisei_3: 4,
      keisei_4: 12,
      keisei_5: 12,
      keisei_6: 12
    },
    color: "green"
  },
  yuri: {
    name: "幼 ユリ",
    description: "気分屋で惚れっぽい\nあなたがすべて",
    image: "image/yuri_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 20,
      keisei_3: 12,
      keisei_4: 4,
      keisei_5: 4,
      keisei_6: 12
    },
    color: "orange"
  },
  takashi: {
    name: "目覚 崇",
    description: "陽気な道化\n異端こそ生き甲斐",
    image: "image/takashi_full.jpg",
    keisei: {
      keisei_1: 4,
      keisei_2: 12,
      keisei_3: 20,
      keisei_4: 4,
      keisei_5: 12,
      keisei_6: 12
    },
    color: "blue"
  },
  saki: {
    name: "風下 咲",
    description: "臆病で親切\n不安に苛まれている",
    image: "image/saki_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 12,
      keisei_3: 12,
      keisei_4: 20,
      keisei_5: 4,
      keisei_6: 4
    },
    color: "purple"
  },
  osamu: {
    name: "文豪 統",
    description: "思考と論理\n我在るのは思う為",
    image: "image/osamu_full.jpg",
    keisei: {
      keisei_1: 4,
      keisei_2: 12,
      keisei_3: 12,
      keisei_4: 12,
      keisei_5: 20,
      keisei_6: 4
    },
    color: "brown"
  },
  tooru: {
    name: "力業 透",
    description: "剛腕と気合\n出来ないことなどない",
    image: "image/tooru_full.jpg",
    keisei: {
      keisei_1: 12,
      keisei_2: 4,
      keisei_3: 4,
      keisei_4: 12,
      keisei_5: 12,
      keisei_6: 20
    },
    color: "red"
  },
};//色整理-NAME

const COLOR_CLASSES = [
  "color-red",
  "color-blue",
  "color-green",
  "color-orange",
  "color-purple",
  "color-brown",
];//色整理-CLASS

const KUNNAN_HP = [30,40,50,60,70,80,90,100,120,150];

const PROGRESS_STEP = 25;
const TICK_INTERVAL = 500;
const COLOR_POOL = ["みどり","オレンジ","あお","むらさき","ブラウン","あか","くろ"];//色整理-NAME-LISTと統合するかも

const GIRL_ORDER = ["淋漓", "唯奈", "スミレ"];

const COLOR_CORE = {
  red:   { name: "あか",
           hex: "#c92a2a",
           class: "color-red",
           keisei: "keisei_6"},
  green: { name: "みどり",
           hex: "#2f9e44",
           class: "color-green",
           keisei: "keisei_1"},
  blue:  { name: "あお",
           hex: "#1c7ed6",
           class: "color-blue",
           keisei: "keisei_3"},
  orange:{ name: "オレンジ",
           hex: "#e67700",
           class: "color-orange",
           keisei: "keisei_2"},
  purple:{ name: "むらさき",
           hex: "#7048e8",
           class: "color-purple",
           keisei: "keisei_4"},
  brown: { name: "ブラウン",
           hex: "#8c4a1f",
           class: "color-brown",
           keisei: "keisei_5"}
};// 色整理-CORE-ID

const KUNNAN_COLOR_HEX = Object.fromEntries(
  Object.entries(COLOR_CORE)
    .filter(([_, c]) => c.hex)
    .map(([id, c]) => [id, c.hex])
);//色整理-ID //色整理-HEX

//色整理-KEISEI-ENTRY
//色ID → 傾性ID への唯一の変換表
const COLOR_TO_KEISEI = Object.fromEntries(
  Object.entries(COLOR_CORE)
    .filter(([_, c]) => c.keisei)
    .map(([id, c]) => [id, c.keisei])
);//色整理-KEISEI //色整理-ID

const COLOR_IDS = Object.entries(COLOR_CORE)
  .filter(([_, c]) => c.hex)
  .map(([id]) => id);//色整理-ID
  
const COLOR_BY_KEISEI = Object.fromEntries(
  Object.entries(COLOR_CORE)
    .filter(([_, c]) => c.keisei)
    .map(([id, c]) => [c.keisei, id])
);

// 異形ID → 所持きっかけ配列
const KIKKAKE_INVENTORY = {
  makoto: [],
  yuri: [],
  takashi: [],
  saki: [],
  osamu: [],
  tooru: []
};

// 直近のドロップ結果（リザルト表示用）
let LAST_DROPPED_KIKKAKE = null;

const ALPHABET = [
  "Ａ","Ｂ","Ｃ","Ｄ","Ｅ","Ｆ","Ｇ","Ｈ","Ｊ","Ｋ","Ｌ","Ｍ",
  "Ｎ","Ｐ","Ｑ","Ｒ","Ｓ","Ｔ","Ｕ","Ｖ","Ｗ","Ｘ","Ｙ","Ｚ",
  "ｂ","ｃ","ｄ","ｆ","ｇ","ｈ","ｋ","ｍ","ｎ","ｐ","ｑ","ｒ","ｓ","ｔ","ｖ","ｘ","ｙ","ｚ"
];

const SYMBOL_OR_NUMBER = [
  "０","１","２","３","４","５","６","７","８","９",
  "／","＋","）","＜","＝","＊","＃","％","＠","＆","￥","：","＾"
];

const HIRAGANA = [
  "あ","も","ふ","や","る","せ","ん","そ","む"
];

let currentGirlIndex = 0;

// 直前の戦闘で起きた「出来事」
// リザルト画面はこれしか見ない
let LAST_BATTLE_EVENT = null;

let currentEnemy = {
  maxHp: 100,
  hp: 100
};

let lastBattle = {
  stage: null,
  hp: null
};

let partners = [];

setInterval(tick, TICK_INTERVAL);

let selectedGirl = null;
let selectedPairs = {};

let currentDepth = 0;
const MIN_DEPTH = 0;
const MAX_DEPTH = 27; // 30 + 10*27 = 300
function calcKunnanHp(depth) {
  return 30 + depth * 10;
}

let currentKunnan = {
  mainColor: null,
  subColor: null,
  hp: 0,
  maxHp: 0
};//色整理-KEISEI //色整理-ID

let currentScreen = "select";

function keiseiByKunnan(monsterId) {
  const char = IKEI_STATUS[monsterId];
  if (!char) return { keiseiA: null, keiseiB: null, valueA: 0, valueB: 0 };

  const keiseiA = COLOR_TO_KEISEI[currentKunnan.mainColor];
  const keiseiB = COLOR_TO_KEISEI[currentKunnan.subColor];
  return {
    keiseiA,
    keiseiB,
    valueA: char.keisei[keiseiA] ?? 0,
    valueB: char.keisei[keiseiB] ?? 0
  };
}

function selectAttackByKunnan(monsterId) {
  const result = keiseiByKunnan(monsterId);
  if (!result) {
    return { hit: false, damage: 0, keisei: null };
  }

  const { keiseiA, keiseiB, valueA, valueB } = result;

  const high = valueA >= valueB
    ? { keisei: keiseiA, value: valueA }
    : { keisei: keiseiB, value: valueB };

  const low = valueA < valueB
    ? { keisei: keiseiA, value: valueA }
    : { keisei: keiseiB, value: valueB };

  // 高い方
  if (COLOR_BY_KEISEI[high.keisei] &&
      colorBag[COLOR_BY_KEISEI[high.keisei]] > 0) {
    return { hit: true, damage: high.value, keisei: high.keisei };
  }

  // 低い方
  if (COLOR_BY_KEISEI[low.keisei] &&
      colorBag[COLOR_BY_KEISEI[low.keisei]] > 0) {
    return { hit: true, damage: low.value, keisei: low.keisei };
  }

  return { hit: false, damage: 0, keisei: null };
}

function selectMonster(monsterId) {
  if (!selectedGirl) return;

  if (Object.values(selectedPairs).includes(monsterId)) {
    alert("その異型は他の少女とパートナーだよ");
    return;
  }
  selectedPairs[selectedGirl] = monsterId;

  if (Object.keys(selectedPairs).length === GIRL_ORDER.length) {
    selectedGirl = null;
    updateGirlStates();
    updateMonsterStates();
    return;
  }
  do {
    currentGirlIndex = (currentGirlIndex + 1) % GIRL_ORDER.length;
    selectedGirl = GIRL_ORDER[currentGirlIndex];
  } while (selectedPairs[selectedGirl]);

  updateGirlStates();
  updateMonsterStates();
}

function updatePartners() {
  partners = [];

  for (let girl in selectedPairs) {
    const monsterId = selectedPairs[girl];

    partners.push({
      girl,
      monsterId,
      monsterName: IKEI_STATUS[monsterId].name, 
      progress: 0,
      speed: 1,
      isComplete: false,
      completeTimer: 0
    });
  }
  updateStatus();
}

function updateGirlStates() {
  document.querySelectorAll('.icon-wrapper[data-girl]').forEach(el => {
    const girl = el.dataset.girl;
    el.classList.remove("selected", "used");

    if (selectedPairs[girl]) {
      el.classList.add("used");
      
    } else if (girl === selectedGirl) {
      el.classList.add("selected");
    }
  });
}

function updateMonsterStates() {
  document
    .querySelectorAll('.icon-wrapper[data-monster-id]')
    .forEach(el => {
      const monsterId = el.dataset.monsterId;

      el.classList.toggle(
        "used",
        Object.values(selectedPairs).includes(monsterId)
      );
    });
}

function updateStatus() {
  const area = document.getElementById("partnerStatus");
  area.innerHTML = "";

  partners.forEach(partner => {
    const ui = createPartnerFrame(partner);
    ui.fill.style.width = `${partner.progress}%`;
    area.appendChild(ui.row);
  });
}

function tick() {
  partners.forEach(partner => {

    if (partner.isComplete) {
      partner.completeTimer--;

      if (partner.completeTimer <= 0) {
        const colorIds = Object.keys(COLOR_CORE);
        const colorId = colorIds[Math.floor(Math.random() * colorIds.length)];
        colorBag[colorId]++;
        renderColorBag();

        partner.progress = 0;
        partner.isComplete = false;
      }
      return;
    }

    partner.progress += PROGRESS_STEP * partner.speed;

    if (partner.progress >= 100) {
      partner.progress = 100;
      partner.isComplete = true;
      partner.completeTimer = 1; 
    }
  });
  updateStatus();
}

function selectGirl(girl) {
  selectedGirl = girl;
  updateGirlStates();
}

function confirmPartner() {
  updatePartners();
  showScreen("search");
}

function showScreen(screenName) {
  const screens = ["select", "search", "status", "battle"];

  // 画面切り替え
  screens.forEach(name => {
    const screen = document.getElementById(name + "Screen");
    if (screen) {
      screen.style.display = name === screenName ? "block" : "none";
    }
  });
  
// 色彩バッグ制御
const colorPanel = document.getElementById("colorPanel");
if (colorPanel) {
  colorPanel.style.display =
    screenName === "search" ||
    screenName === "status" ||
    screenName === "select" ||
    screenName === "battle"
      ? "block"
      : "none";
}

  // select画面初期化
  if (screenName === "select") {
    currentGirlIndex = 0;
    selectedGirl = GIRL_ORDER[currentGirlIndex];
    updateGirlStates();
  }

  // battle画面初期化（苦難ゲート）
  if (screenName === "battle") {
    setupKunnanGateEvents();
    const gate = document.getElementById("kunnanGate");
    const battle = document.getElementById("battleArea");

    if (gate) gate.style.display = "block";
    if (battle) battle.style.display = "none";

    updateGateBackground();
  }

  // status画面描画
  if (screenName === "status") {
    renderStatusTabs();
    renderStatusScreen();
  }

  currentScreen = screenName;
}


function createPartnerFrame(partner) {
  const row = document.createElement("div");
  row.className = "partner-row";

  const girlImg = document.createElement("img");
  girlImg.src = girlImages[partner.girl];
  girlImg.className = "icon-small";

  const monsterImg = document.createElement("img");
  monsterImg.src = monsterImages[partner.monsterId];
  monsterImg.className = "icon-small";

  const gauge = document.createElement("div");
  gauge.className = "gauge";

  const fill = document.createElement("div");
  fill.className = "gauge-fill";
  fill.style.width = `${partner.progress}%`;

  gauge.appendChild(fill);

  row.appendChild(girlImg);
  row.appendChild(monsterImg);
  row.appendChild(gauge);

  const removeBtn = document.createElement("button");
   removeBtn.textContent = "×";
   removeBtn.onclick = () => removePartner(partner);

   row.appendChild(removeBtn);

  return { row, fill };
}

function renderColorBag() {
  const bag = document.getElementById("bag");
  const warehouse = document.getElementById("warehouse");

  bag.innerHTML = "";
  warehouse.innerHTML = "";

   for (let color in colorBag) {
  const count = colorBag[color];
  if (count === 0) continue;
  if (!COLOR_CORE[color]) continue;
  
    /* ===== バッグ（● 最大10） ===== */
    const bagFrame = document.createElement("div");
    bagFrame.className = "color-group";
    const bagCount = Math.min(count, 10);
   for (let i = 0; i < bagCount; i++) {
  const dot = document.createElement("span");

  dot.className = "color-orb";

  dot.classList.add(COLOR_CORE[color].class);//色整理
  bagFrame.appendChild(dot);
}
bag.appendChild(bagFrame);

    /* ===== 倉庫（× 最大100） ===== */
    if (count > 10) {
      const group = document.createElement("div");
      group.className = "color-group";
      const orb = document.createElement("span");
      orb.className = "color-orb";
      orb.classList.add(COLOR_CORE[color].class);//色整理
      const text = document.createElement("span");
      const warehouseCount = Math.min(count - 10, 100); 
      text.textContent = `× ${warehouseCount}`;

group.appendChild(orb);
group.appendChild(text);
warehouse.appendChild(group);
    }
  }
}

function removePartner(partner) {
  
  partners = partners.filter(t => t !== partner);
  delete selectedPairs[partner.girl];

  updateGirlStates();
  updateMonsterStates();
  updateStatus();
}

function handleMainButton() {
  if (currentScreen === "select") {
    confirmPartner();
  } else {
    showScreen("select");
  }
}

// ステータス大枠
function renderStatusScreen() {
  const area = document.getElementById("statusList");
  area.innerHTML = "";
  
  Object.entries(IKEI_STATUS).forEach(([id, char]) => {
    const card = createStatusCard(char, id);
  area.appendChild(card);
  });
}

function renderStatusTabs() {
  const tabs = document.getElementById("statusTabs");
  tabs.innerHTML = "";
  
  const allOrb = document.createElement("span");
  allOrb.className = "color-orb all";
  allOrb.dataset.charId = "all";
  allOrb.textContent = "ALL";

  allOrb.onclick = () => selectTab("all");
  tabs.appendChild(allOrb);
  
  Object.entries(IKEI_STATUS).forEach(([id, char]) => {
    const orb = document.createElement("span");
    orb.className = `color-orb ${colorClassMap[char.color]}`;//色整理
    orb.title = char.name;
    orb.dataset.charId = id;
    orb.onclick = () => {
  selectTab(id);
  showSingleStatus(id);
};
    tabs.appendChild(orb);
  });
}

function showSingleStatus(charId) {
  document.querySelectorAll(".status-card").forEach(card => {
    card.style.display =
      card.dataset.charId === charId ? "block" : "none";
  });
}

// ステータス詳細
function createStatusCard(char, charId) {
  const card = document.createElement("div");
  card.className = "status-card";
  card.dataset.charId = charId;

  const top = document.createElement("div");
  top.className = "status-top";

  const img = document.createElement("img");
  img.src = char.image;
  img.className = "status-image";

  const header = document.createElement("div");
  header.className = "status-header";

  const name = document.createElement("strong");
  name.className = "status-name";
  name.textContent = char.name;

  const desc = document.createElement("div");
  desc.textContent = char.description;

  header.appendChild(name);
  header.appendChild(desc);
  top.appendChild(img);
  top.appendChild(header);

  const center = document.createElement("div");
  center.className = "status-center";

  Object.entries(char.keisei).forEach(([key, value]) => {
    const row = document.createElement("div");
    row.className = "keisei-row";

    const label = document.createElement("span");
    label.className = "keisei-label";
    label.textContent = keisei_LABELS[key];

    const dotBox = document.createElement("div");
    dotBox.className = "keisei-dot";

    const colorClass = colorClassMap[char.color];//色整理
    const count = keiseiDot(value);

    for (let i = 0; i < count; i++) {
      const orb = document.createElement("span");
      orb.className = `color-orb ${colorClass}`;
      dotBox.appendChild(orb);
    }

    const bar = document.createElement("div");
    bar.className = "keisei-bar";

    row.appendChild(label);
    row.appendChild(dotBox);
    row.appendChild(bar);
    center.appendChild(row);
  });

  const bottom = document.createElement("div");
  bottom.className = "status-bottom";
  
    const check = document.createElement("div");
    check.className = "status-CheckArea";
    check.style.background = COLOR_CORE[char.color].hex;

    // SVG
    check.innerHTML = `
<svg class="check-svg" width="32" height="32" viewBox="0 0 32 32">
  <path
    d="M6 16 L13 23 L26 8"
    fill="none"
    stroke="#fff"
    stroke-width="5"
    stroke-linecap="round"
    stroke-linejoin="round"
  /></svg>`;

  const svg = check.querySelector(".check-svg");
  // popup
  const popup = document.createElement("div");
  popup.className = "kikkake-popup";

    const kikkakelist = document.createElement("div");
    kikkakelist.className = "status-kikkake-list";
    renderKikkakePopup(charId, kikkakelist);

    popup.appendChild(kikkakelist);
    check.appendChild(popup);
    bottom.appendChild(check);
    
  check.addEventListener("click", () => {
  if (!svg) return;

  const willOpen = !check.classList.contains("show-popup");
  check.classList.toggle("show-popup");
  if (willOpen) {
    const path = svg.querySelector("path");

    // ① アニメーションを完全に殺す
    path.style.animation = "none";

    // ② 強制 reflow
    void path.getBoundingClientRect();

    // ③ クラスを付け直す
    path.style.animation = "";
    svg.classList.remove("redraw");
    void svg.offsetWidth;
    svg.classList.add("redraw");
  }
});
  
card.appendChild(top);
card.appendChild(center);
card.appendChild(bottom);
  return card;
}

function selectTab(charId) {
  activeStatusId = charId;

  document.querySelectorAll(".status-card").forEach(card => {
  card.style.display =
  charId === "all" || card.dataset.charId === charId  ? "block"  : "none";
});
  document.querySelectorAll("#statusTabs .color-orb").forEach(orb => {
    orb.classList.toggle("active", orb.dataset.charId === charId);
  });
}

let activeStatusId = "all";

function keiseiDot(value) {
  if (value >= 16) return 3;
  if (value >= 8) return 2;
  return 1;
}

const buttonsArea = document.getElementById("kunnanButtons");

function renderKunnans(stage) {
  buttonsArea.innerHTML = "";

  KUNNAN_HP.forEach((hp, index) => {
    const btn = document.createElement("button");
    btn.className = "kunnan-btn";
    btn.textContent = `${index + 1}`;

    btn.onclick = () => {
  setActiveButton(btn);
  startBattle(stage, hp);
};
    buttonsArea.appendChild(btn);
  });
}

function setActiveButton(activeBtn) {
  document.querySelectorAll(".kunnan-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  activeBtn.classList.add("active");
}

function startBattle(stage, hp) {

  const { mainColor, subColor } = pickMainAndSubColors();
  
  currentKunnan.mainColor = mainColor;
  currentKunnan.subColor  = subColor;
  
  const main = document.querySelector(".kunnan-main");
  const sub  = document.querySelector(".kunnan-sub");
  
  main.style.setProperty(
  "--main-color",
  KUNNAN_COLOR_HEX[mainColor]
);
  sub.style.setProperty(
  "--sub-color",
  KUNNAN_COLOR_HEX[subColor]
);//色整理-HEX

  renderBattlePartners();
  document.getElementById("battleArea").style.display = "block";
  
  lastBattle.stage = stage;
  lastBattle.hp = hp;

  currentEnemy.maxHp = hp;
  currentEnemy.hp = hp;
  renderEnemyHp();
  
  currentKunnan.maxHp = hp;
  currentKunnan.hp = hp;
  
  const mainMask = createMainMask();
  const subMask  = createSubMask();

  main.style.maskImage = `url(${mainMask.toDataURL()})`;
  main.style.webkitMaskImage = `url(${mainMask.toDataURL()})`;

  sub.style.maskImage = `url(${subMask.toDataURL()})`;
  sub.style.webkitMaskImage = `url(${subMask.toDataURL()})`;

  main.style.maskSize = sub.style.maskSize = "cover";
  main.style.maskRepeat = sub.style.maskRepeat = "no-repeat";
}
  
function showBattleResult() {
  document.getElementById("battleArea").style.display = "none";
  document.getElementById("battleResult").style.display = "block";
  renderKikkakeResult();
}
  
// 逃げる
function escapeBattle() {
  closeBattleResult();
  document.getElementById("battleArea").style.display = "none";
  document.getElementById("kunnanGate").style.display = "block";
}

document.querySelectorAll(".escape-button").forEach(btn => {
  btn.addEventListener("click", escapeBattle);
});

// 苦難 侵食 メイン（歪んだ核）
function createMainMask(size = 200) {
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size / 2;
  const cy = size / 2;

  ctx.fillStyle = "black";

  const coreCount = 2 + Math.floor(Math.random() * 3);

  for (let i = 0; i < coreCount; i++) {
    const angle = Math.random() * Math.PI * 2;
    const offset = size * (0.05 + Math.random() * 0.40);
    const r = size * (0.22 + Math.random() * 0.12);

    const x = cx + Math.cos(angle) * offset;
    const y = cy + Math.sin(angle) * offset;

    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }
  return canvas;
}

// 苦難 侵食 サブ
function createSubMask(size = 200) {
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");

  const cx = size / 2;
  const cy = size / 2;
  ctx.fillStyle = "black";
  const count = 8 + Math.floor(Math.random() * 15);
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const dist = size * (0.25 + Math.random() * 0.2);
    const r = size * (0.03 + Math.random() * 0.05);
    const x = cx + Math.cos(angle) * dist;
    const y = cy + Math.sin(angle) * dist;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
  }  return canvas;
}

function pickMainAndSubColors() {
  const mainColor = COLOR_IDS[Math.floor(Math.random() * COLOR_IDS.length)];
  let subColor;

  do {
    subColor = COLOR_IDS[Math.floor(Math.random() * COLOR_IDS.length)];
  } while (subColor === mainColor);

  return { mainColor, subColor };
}//色整理-ID

document.querySelectorAll(".girl-icon").forEach(img => {
  img.addEventListener("click", () => {
    const girl = img.dataset.girl;
    selectGirl(girl);
  });
});

document.querySelectorAll(".monster-icon").forEach(img => {
  img.addEventListener("click", (e) => {
    const monsterId =
      e.currentTarget.closest(".icon-wrapper").dataset.monsterId;

    selectMonster(monsterId);
  });
});

function renderEnemyHp() {
  const fill = document.querySelector(".enemy-hp-fill");
  const text = document.querySelector(".enemy-hp-text");
  if (!fill || !text) return;

  const ratio = currentEnemy.hp / currentEnemy.maxHp;
  fill.style.width = `${Math.max(0, ratio * 100)}%`;

  text.textContent = `${currentEnemy.hp} / ${currentEnemy.maxHp}`;
}

function fightOnce(monsterId) {
  const result = selectAttackByKunnan(monsterId);
  if (!result.hit) return;

  const colorId = COLOR_BY_KEISEI[result.keisei];
  if (!colorId) return;

  colorBag[colorId]--;
  renderColorBag();

  currentEnemy.hp -= result.damage;
  if (currentEnemy.hp < 0) currentEnemy.hp = 0;

  renderEnemyHp();
  
  if (currentEnemy.hp === 0) {
    // ★ ここで「その戦闘の出来事」を確定させる
    LAST_BATTLE_EVENT = dropKikkakeForPartners();
    showBattleResult();
  }
}

function fightAgain() {
  closeBattleResult();

  if (!lastBattle.hp) {
    document.getElementById("kunnanSelect").style.display = "block";
    return;
  }
  startBattle(lastBattle.stage, lastBattle.hp);
}

document.querySelectorAll(".fight-again-button").forEach(btn => {
  btn.addEventListener("click", fightAgain);
});

function closeBattleResult() {
  document.getElementById("battleResult").style.display = "none";
  LAST_BATTLE_EVENT = null;
}

function renderBattlePartners() {
  const area = document.querySelector(".battle-partners");
  if (!area) return;

  area.innerHTML = "";

  partners.forEach(partner => {
    const wrapper = document.createElement("div");
    wrapper.className = "battle-partner";

    const img = document.createElement("img");
    img.src = monsterImages[partner.monsterId];
    img.dataset.monsterId = partner.monsterId;
    img.className = "icon-image battle-partner-icon";

    img.addEventListener("click", () => {
      animateAttack(img);
      fightOnce(partner.monsterId);
    });
    const stats = document.createElement("div");
    stats.className = "battle-partner-stats";

    wrapper.appendChild(img);
    wrapper.appendChild(stats);
    area.appendChild(wrapper);
    renderBattlePartnerStats(wrapper, partner.monsterId);
  });
}

function renderBattlePartnerStats(wrapper, monsterId) {
  const statsArea = wrapper.querySelector(".battle-partner-stats");
  if (!statsArea) return;

  const result = keiseiByKunnan(monsterId);
  if (!result) return;

  const { keiseiA, keiseiB, valueA, valueB } = result;

  const labelA = keisei_LABELS[keiseiA];
  const labelB = keisei_LABELS[keiseiB];

  statsArea.innerHTML = `
    <div>${labelA} : ${valueA}</div>
    <div>${labelB} : ${valueB}</div>
  `;
}//色整理-KEISEI //色整理-ID

function animateAttack(icon) {
  if (!icon) return;
  icon.classList.add("attack");

  setTimeout(() => {
    icon.classList.remove("attack");
  }, 150);
}

function startPartnerSelection(startGirl) {
  currentGirlIndex = GIRL_ORDER.indexOf(startGirl);
  selectedGirl = startGirl;
  updateGirlStates();
}

function calcAttackPower(monsterId) {
  const result = keiseiByKunnan(monsterId);
  if (!result) return 0;

  const { valueA, valueB } = result;
  return Math.max(valueA, valueB);
}//色整理-KEISEI //色整理-ID

function createTestKikkake() {
  return {
    code: generateEnhanceCode(), // さっき作ったやつ
    bonus: {
      keisei_1: 1,
      keisei_2: 1,
      keisei_3: 1,
      keisei_4: 1,
      keisei_5: 1,
      keisei_6: 1
    }
  };
}

function dropKikkakeForPartners() {
  if (partners.length === 0) return null;

  const partner =
    partners[Math.floor(Math.random() * partners.length)];

  const monsterId = partner.monsterId;
  const inventory = KIKKAKE_INVENTORY[monsterId];

  const kikkake = createTestKikkake();

  const canStore = inventory.length < 5;

  if (canStore) {
    inventory.push(kikkake);
  }

  // ★ 戦闘結果として返す「出来事」
  return {
    monsterId,
    code: kikkake.code,
    dropped: true,          // ✔ を出す条件
    stored: canStore        // 捨てたかどうか
  };
}

function renderKikkakePopup(charId, container) {
  container.innerHTML = "";

  const list = KIKKAKE_INVENTORY[charId];

  // ★ ここが重要
  if (!Array.isArray(list)) {
    const empty = document.createElement("div");
    empty.className = "kikkake-item";
    empty.textContent = "（なし）";
    container.appendChild(empty);
    return;
  }

  list.forEach(item => {
    const el = document.createElement("div");
    el.className = "kikkake-item";
    el.textContent = item.code;
    container.appendChild(el);
  });

  if (list.length === 0) {
    const empty = document.createElement("div");
    empty.className = "kikkake-item";
    empty.textContent = "（なし）";
    container.appendChild(empty);
  }
}

function generateEnhanceCode() {
  let code = [];
  // 1文字目：▼ 固定
  code.push("▼");
  // 2〜4文字目：英字（同一連続不可）
  let prev = null;
  for (let i = 0; i < 3; i++) {
    const c = pickRandom(ALPHABET, prev);
    code.push(c);
    prev = c;
  }
  // 5文字目：数字 or 記号
  // 5文字目：数字 or 記号
    const mid = pickRandom(SYMBOL_OR_NUMBER);
    code.push(mid);

// ここで prev をリセット
    prev = null;

// 6文字目：英字（直前と同一不可、だが mid とは被らないので実質自由）
    const alpha2 = pickRandom(ALPHABET, prev);
    code.push(alpha2);
  // 7文字目：ひらがな固定
  const hira = pickRandom(HIRAGANA);
  code.push(hira);

  return code.join("");
}

function pickRandom(array, except = null) {
  let choice;
  do {
    choice = array[Math.floor(Math.random() * array.length)];
  } while (choice === except);
  return choice;
}

function renderKikkakeResult() {
  const area = document.getElementById("kikkakeResult");
  area.innerHTML = "";

  const event = LAST_BATTLE_EVENT;
  if (!event || !event.dropped) return;

  const wrapper = document.createElement("div");
  wrapper.style.display = "flex";
  wrapper.style.flexDirection = "column";
  wrapper.style.color = "#000";

  // 1行目
  const line1 = document.createElement("div");
  line1.style.display = "flex";
  line1.style.alignItems = "center";
  line1.style.gap = "6px";

  // ✔
  const check = document.createElement("div");
  check.style.width = "16px";
  check.style.height = "16px";
  check.style.borderRadius = "4px";
  check.style.display = "flex";
  check.style.alignItems = "center";
  check.style.justifyContent = "center";
  check.style.background =
    COLOR_CORE[IKEI_STATUS[event.monsterId].color].hex;

  check.innerHTML = `
<svg width="12" height="12" viewBox="0 0 32 32">
  <path
    d="M6 16 L13 23 L26 8"
    fill="none"
    stroke="#fff"
    stroke-width="5"
    stroke-linecap="round"
    stroke-linejoin="round"
  />
</svg>`;
  const text = document.createElement("span");
  text.textContent = `${event.code} を獲得した`;

  line1.appendChild(check);
  line1.appendChild(text);
  wrapper.appendChild(line1);

  // 2行目（条件付き）
  if (!event.stored) {
    const line2 = document.createElement("div");
    line2.textContent = "持ちきれないので捨てた";
    line2.style.marginLeft = "22px";
    line2.style.opacity = "0.5";
    wrapper.appendChild(line2);
  }
  area.appendChild(wrapper);
}

function updateGateBackground() {
  const gate = document.getElementById("kunnanGate");
  if (!gate) return;

  const ratio = Math.min(currentDepth / 20, 1);
  const value = Math.floor(255 * (1 - ratio));
  gate.style.setProperty(
    "--gate-bg",
    `rgb(${value}, ${value}, ${value})`
  );
}

function showKunnanGate() {
  const gate = document.getElementById("kunnanGate");
  const battle = document.getElementById("battleArea");

  if (gate) gate.style.display = "block";
  if (battle) battle.style.display = "none";
  updateGateBackground();
    setupKunnanGateEvents(); 
}

function setupKunnanGateEvents() {
  const shallowBtn = document.getElementById("goShallow");
  if (shallowBtn) {
    shallowBtn.onclick = () => {
      if (currentDepth > MIN_DEPTH) {
        currentDepth--;
        updateGateBackground();
      }
    };
  }

  const deepBtn = document.getElementById("goDeep");
  if (deepBtn) {
    deepBtn.onclick = () => {
      if (currentDepth < MAX_DEPTH) {
        currentDepth++;
        updateGateBackground();
      }
    };
  }

  const enterBtn = document.getElementById("enterKunnan");
  if (enterBtn) {
    enterBtn.onclick = () => {
      const hp = calcKunnanHp(currentDepth);

      const gate = document.getElementById("kunnanGate");
      if (gate) gate.style.display = "none";

      const battle = document.getElementById("battleArea");
      if (battle) battle.style.display = "block";

      startBattle(null, hp);
    };
  }
}




</script>

<footer id="pageFooter"><img src="image/logo.png" alt="色彩UM ロゴ"></footer>

</div> </body> </html>